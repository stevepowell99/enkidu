<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Enkidu</title>

    <!-- Bootstrap (styling only; keep frontend super simple for v0) -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <!-- Bootstrap Icons (CDN) -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
      rel="stylesheet"
    />

    <!-- Markdown render (preview only) -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <link rel="stylesheet" href="/app.css" />
  </head>
  <body class="bg-light">
    <main class="container-fluid py-3 enkidu-app">
      <!-- Top bar -->
      <div id="topBar" class="d-flex flex-wrap align-items-center gap-3 mb-2">
        <h1 class="h4 mb-0">Enkidu</h1>

        <div
          id="status"
          class="alert alert-secondary py-1 px-2 small mb-0 text-truncate"
          style="max-width: 52rem"
          role="status"
        >
          Not connected yet.
        </div>

        <span id="embeddingStatus" class="badge text-bg-secondary">Embeddings: ?</span>

        <div class="d-flex flex-wrap align-items-center gap-2 ms-auto">
          <div class="form-check form-switch mb-0">
            <input class="form-check-input" type="checkbox" role="switch" id="allowSecrets" />
            <label class="form-check-label small" for="allowSecrets">Allow suspected secrets (override)</label>
          </div>

          <div class="input-group input-group-sm" style="width: 26rem">
            <span class="input-group-text">API base</span>
            <input id="apiBaseUrl" class="form-control" type="text" placeholder="(blank = same origin)" />
            <button id="saveApiBase" class="btn btn-outline-primary" type="button">Save</button>
          </div>

          <div class="input-group input-group-sm" style="width: 26rem">
            <span class="input-group-text">Admin token</span>
            <input id="adminToken" class="form-control" type="password" placeholder="ENKIDU_ADMIN_TOKEN" />
            <button id="saveToken" class="btn btn-primary" type="button">Save</button>
          </div>
        </div>
      </div>

      <!-- Two-panel layout -->
      <div class="row g-3 enkidu-main-row">
        <!-- Chat panel -->
        <div class="col-12 col-lg-6">
          <div class="card h-100 enkidu-chat-card">
            <div class="card-header d-flex gap-2 align-items-center">
              <div class="fw-semibold">Chat</div>
              <div class="ms-auto d-flex gap-2 align-items-center">
                <span class="badge text-bg-secondary" id="payloadCount" title="Selected recall pages to include in the next chat request">Payload: 0</span>
                <button id="clearPayload" class="btn btn-sm btn-outline-secondary" type="button">Clear</button>
                <button id="runDream" class="btn btn-sm btn-outline-secondary" type="button">Dream</button>
                <label class="form-label small mb-0" for="chatModel">Model</label>
                <select id="chatModel" class="form-select form-select-sm" style="width: 14rem">
                  <option value="">(loading...)</option>
                </select>
                <label class="form-label small mb-0" for="threadSelect">Thread</label>
                <select id="threadSelect" class="form-select form-select-sm" style="width: 18rem">
                  <option value="">(new thread)</option>
                </select>
              </div>
            </div>
            <div class="card-body">
              <div id="chatLog" class="enkidu-scroll border rounded p-2 bg-light"></div>
              <div class="mt-2 input-group">
                <textarea id="chatInput" class="form-control" rows="2" placeholder="Message..."></textarea>
                <button id="sendChat" class="btn btn-primary" type="button">Send</button>
                <button id="searchLocal" class="btn btn-outline-primary" type="button" title="Run local Related/Recall search (does not call chat)">
                  Search
                </button>
              </div>
              <div class="form-check form-switch mt-2">
                <input class="form-check-input" type="checkbox" role="switch" id="useWebSearch" />
                <label class="form-check-label small" for="useWebSearch" title="When on, chat requests can use Gemini web_search grounding">
                  Web search
                </label>
              </div>
              <div class="mt-2 d-flex gap-2">
                <button id="reloadChat" class="btn btn-sm btn-outline-secondary" type="button">Reload thread</button>
                <button id="newThread" class="btn btn-sm btn-outline-secondary" type="button">New thread</button>
                <button id="deleteThread" class="btn btn-sm btn-outline-danger" type="button">Delete thread</button>
              </div>
            </div>
          </div>
        </div>

        <!-- Recall panel -->
        <div class="col-12 col-lg-6">
          <div class="card h-100 enkidu-recall-card">
            <div class="card-header d-flex gap-2 align-items-center">
              <div class="fw-semibold">Recall</div>
              <div class="ms-auto d-flex gap-2 align-items-center">
                <div class="btn-group btn-group-sm" role="group" aria-label="Related matchers" id="relatedMatcherGroup">
                  <input type="checkbox" class="btn-check" id="matchTime" autocomplete="off" checked />
                  <label class="btn btn-outline-secondary" for="matchTime" title="Time: most recent pages first">
                    <i class="bi bi-clock-history"></i>
                  </label>

                  <input type="checkbox" class="btn-check" id="matchText" autocomplete="off" checked />
                  <label class="btn btn-outline-secondary" for="matchText" title="Text: word overlap with your current draft message">
                    <i class="bi bi-fonts"></i>
                  </label>

                  <input type="checkbox" class="btn-check" id="matchTitle" autocomplete="off" checked />
                  <label class="btn btn-outline-secondary" for="matchTitle" title="Title: word overlap with page titles">
                    <i class="bi bi-card-text"></i>
                  </label>

                  <input type="checkbox" class="btn-check" id="matchEmbeddings" autocomplete="off" checked />
                  <label class="btn btn-outline-secondary" for="matchEmbeddings" title="Embeddings: server-side semantic similarity">
                    <i class="bi bi-stars"></i>
                  </label>
                </div>
              </div>
            </div>
            <div class="card-body">
              <div class="input-group mb-2">
                <input id="recallTag" class="form-control" placeholder="Tag filter (single tag)..." list="tagSuggestions" />
                <datalist id="tagSuggestions"></datalist>
                <input id="recallKvKey" class="form-control" placeholder="KV key (e.g. role)" list="kvKeySuggestions" />
                <datalist id="kvKeySuggestions"></datalist>
                <input id="recallKvValue" class="form-control" placeholder="KV value (e.g. assistant)" />
                <button id="recallSearch" class="btn btn-outline-primary" type="button">Search</button>
              </div>

              <div class="row g-2">
                <div class="col-12 col-md-5">
                  <div class="d-flex justify-content-end mb-2">
                    <button id="toggleRelatedAll" class="btn btn-sm btn-outline-secondary" type="button">
                      Select all
                    </button>
                  </div>
                  <div id="recallResults" class="enkidu-scroll border rounded p-2 bg-light"></div>
                </div>
                <div class="col-12 col-md-7">
                  <div class="mb-2 d-flex gap-2">
                    <button id="deletePage" class="btn btn-sm btn-outline-danger" type="button" title="Delete" aria-label="Delete">
                      <i class="bi bi-trash"></i>
                    </button>
                  </div>

                  <!-- Purpose: when nothing is selected, keep the panel minimal (avoid editing "phantom" pages). -->
                  <div id="recallEditorEmpty" class="alert alert-secondary py-2">
                    <!-- Purpose: make the "new page" action big + obvious when nothing is selected. -->
                    <button id="newPage" class="btn btn-primary w-100 text-start" type="button" title="New page" aria-label="New page">
                      <div class="fw-semibold">
                        <i class="bi bi-file-earmark-plus me-2"></i>New page
                      </div>
                      <div class="small opacity-75">Select a page on the left, or click to create one.</div>
                    </button>
                  </div>

                  <!-- Purpose: editor fields are only shown when a page is selected OR when in "New page" mode. -->
                  <div id="recallEditorFields" class="d-none">
                    <div class="mb-2">
                      <label class="form-label small mb-1" for="pageTitle">Title</label>
                      <input id="pageTitle" class="form-control form-control-sm" />
                    </div>

                    <div class="mb-2">
                      <label class="form-label small mb-1" for="pageTags">Tags (comma-separated)</label>
                      <div class="input-group input-group-sm">
                        <input id="pageTags" class="form-control" placeholder="e.g. style, preference" />
                        <select id="pageTagPreset" class="form-select w-auto" style="max-width: 12rem" title="Add preset tags">
                          <option value="">(add preset tagsâ€¦)</option>
                          <option value="*system,*preference">System base page</option>
                          <option value="*style,*preference">Style base page</option>
                          <option value="*bio,*preference">Bio base page</option>
                          <option value="*strategy,*preference">Strategy base page</option>
                          <option value="*dream-prompt,*preference">Dream base page</option>
                          <option value="*split-prompt,*preference">Split base page</option>
                        </select>
                      </div>
                    </div>

                    <!-- Purpose: keep the UI tidy; collapse KV tags by default when there are "many" keys. -->
                    <details id="kvSection" class="mb-2" open>
                      <summary class="d-flex align-items-center gap-2 small">
                        <span class="fw-semibold">KV tags (JSON)</span>
                        <span id="kvSectionCount" class="badge text-bg-secondary">0</span>
                        <span class="ms-auto text-secondary">expand/collapse</span>
                      </summary>
                      <div class="mt-2">
                        <!-- Purpose: KV tags builder (easy add/edit/delete). Textarea remains the source of truth (backend unchanged). -->
                        <div id="kvTagsBuilder" class="border rounded p-2 bg-white mb-1">
                          <div class="d-flex align-items-center gap-2 mb-1">
                            <div class="small text-secondary">Builder</div>
                            <button id="kvTagsAddRow" class="btn btn-sm btn-outline-secondary ms-auto" type="button">Add</button>
                          </div>
                          <div class="table-responsive">
                            <table class="table table-sm mb-1 align-middle">
                              <thead>
                                <tr class="small text-secondary">
                                  <th style="width: 35%">Key</th>
                                  <th>Value</th>
                                  <th style="width: 1%"></th>
                                </tr>
                              </thead>
                              <tbody id="kvTagsRows"></tbody>
                            </table>
                          </div>
                          <div id="kvTagsBuilderMsg" class="small text-danger"></div>
                        </div>
                        <!-- Purpose: KV builder suggestions (keys + per-key values). -->
                        <datalist id="kvTagsKeySuggestions"></datalist>
                        <datalist id="kvTagsValueSuggestions"></datalist>
                        <textarea
                          id="pageKvTags"
                          class="form-control form-control-sm font-monospace"
                          rows="2"
                          placeholder='e.g. {"role":"assistant","kind":"note"}'
                        ></textarea>
                        <div class="form-text small">Tip: values can be plain text (saved as strings) or JSON literals like <span class="font-monospace">true</span>, <span class="font-monospace">123</span>, <span class="font-monospace">{"x":1}</span>.</div>
                      </div>
                    </details>

                    <div class="mb-2 enkidu-md-wrap">
                      <label class="form-label small mb-1" for="pageContent">Markdown</label>
                      <textarea id="pageContent" class="form-control" rows="10"></textarea>
                    </div>

                    <div class="mb-2 enkidu-preview-wrap">
                      <label class="form-label small mb-1">Rendered (double-click to edit)</label>
                      <div id="pagePreview" class="border rounded p-2 bg-white enkidu-preview"></div>
                    </div>

                    <div class="text-secondary small">
                      Selected page id: <span id="pageId">(none)</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>

    <!-- Wikilink picker (Obsidian-style [[Title]] insert) -->
    <div
      id="wikilinkPicker"
      class="card shadow-sm"
      style="display:none; position:fixed; z-index:2000; width: 28rem;"
      aria-label="Wikilink picker"
    >
      <div class="card-body p-2">
        <div class="d-flex align-items-center gap-2 mb-1">
          <div class="small text-secondary">Link to page</div>
          <div class="ms-auto small text-secondary font-monospace" id="wikilinkPickerQuery"></div>
        </div>
        <div id="wikilinkPickerList" class="list-group list-group-flush"></div>
      </div>
    </div>

    <!-- Preview modal (no Bootstrap JS; simple overlay) -->
    <div id="enkiduPreviewModal" class="enkidu-modal-backdrop d-none" aria-hidden="true">
      <div class="card shadow enkidu-modal-panel" role="dialog" aria-modal="true" aria-label="Preview modal">
        <div class="card-header py-2 d-flex align-items-center gap-2">
          <div class="fw-semibold text-truncate" id="enkiduPreviewModalTitle">Preview</div>
          <button id="enkiduPreviewModalClose" type="button" class="btn btn-sm btn-outline-secondary ms-auto" aria-label="Close">
            <i class="bi bi-x-lg" aria-hidden="true"></i>
          </button>
        </div>
        <div class="card-body enkidu-modal-body" id="enkiduPreviewModalBody"></div>
      </div>
    </div>

    <script src="/app.js"></script>
  </body>
</html>


